<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="~{fragments/layout :: head('Dashboard-old')}"></head>
<body>
<header th:replace="~{fragments/layout :: header('dashboard-old')}"></header>
<main class="container">

    <form class="bar" method="get" action="/dashboard-old">
        <label>Account</label>
        <input name="account" th:value="${account}" placeholder="primary"/>
        <label>Fiat</label>
        <select name="vs" th:value="${vs}">
            <option value="gbp" th:selected="${vs=='gbp'}">GBP</option>
            <option value="usd" th:selected="${vs=='usd'}">USD</option>
            <option value="eur" th:selected="${vs=='eur'}">EUR</option>
        </select>
        <button type="submit">Apply</button>
        <a class="btn" th:href="@{'/reconcile'(account=${account})}">Reconcile</a>
        <a class="btn" th:href="@{'/tx'(account=${account})}">Transactions</a>
    </form>

    <div class="grid g2">
        <!-- Totals per platform -->
        <section class="card">
            <h2>Platform totals</h2>
            <div class="content">
                <table>
                    <thead>
                    <th>Platform</th>
                    <th class="right">Value (<span th:text="${vs?.toUpperCase()}">GBP</span>)</th>
                    </thead>
                    <tbody>
                    <tr th:each="p : ${platformTotals}">
                        <td th:text="${p.platform}">Binance</td>
                        <td class="right" th:text="${#numbers.formatDecimal(p.value,1,2)}">0.00</td>
                    </tr>
                    <tr>
                        <th>Total</th>
                        <th class="right" th:text="${#numbers.formatDecimal(grandTotal,1,2)}">0.00</th>
                    </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Pie + top tokens -->
        <section class="card">
            <h2>Allocation by token</h2>
            <div class="content">
                <div class="grid g2">
                    <div class="pie-wrap">
                        <canvas id="pie" width="380" height="380"></canvas>
                    </div>
                    <div>
                        <table>
                            <thead><tr><th>Token</th><th class="right">Value</th></tr></thead>
                            <tbody>
                            <tr th:each="r : ${topTokens}">
                                <td th:text="${r.asset}">BTC</td>
                                <td class="right" th:text="${#numbers.formatDecimal(r.value,1,2)}">0.00</td>
                            </tr>
                            </tbody>
                        </table>
                        <div class="muted" style="margin-top:8px">Small positions are grouped into “Other”.</div>
                    </div>
                </div>
            </div>
        </section>

    <!-- Ingest buttons -->
    <section class="card" style="margin-top:16px">
        <h2>Ingest</h2>
        <div class="content bar">
            <form method="post" action="/binance/ingest-trades"><input type="hidden" name="account" th:value="${account}"><button>Trades</button></form>
            <form method="post" action="/binance/ingest-deposits"><input type="hidden" name="account" th:value="${account}"><button>Deposits</button></form>
            <form method="post" action="/binance/ingest-withdrawals"><input type="hidden" name="account" th:value="${account}"><button>Withdrawals</button></form>
            <form method="post" action="/binance/ingest-dust"><input type="hidden" name="account" th:value="${account}"><button>Dust</button></form>
            <form method="post" action="/binance/ingest-convert"><input type="hidden" name="account" th:value="${account}"><button>Convert</button></form>
            <form method="post" action="/binance/ingest-rewards"><input type="hidden" name="account" th:value="${account}"><button>Rewards</button></form>
            <form method="post" action="/dashboard-old/ingest-all"><input type="hidden" name="account" th:value="${account}"><input type="hidden" name="vs" th:value="${vs}"><button><strong>All (since checkpoint)</strong></button></form>
            <form method="post" action="/binance/ingest-trades-from-list"><input type="hidden" name="account" th:value="${account}"><input type="hidden" name="vs" th:value="${vs}"><input type="hidden" name="since" value="2019-01-01T00:00:00Z"><button>Trades (from list)</button></form>
        </div>
    </section>
</main>
<footer th:replace="~{fragments/layout :: footer}"></footer>


<!-- Ensure Chart.js is loaded once (v4) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Inline the arrays as proper JS literals -->
<script th:inline="javascript">
/*<![CDATA[*/
const pieLabels = /*[[${pieLabels}]]*/ [];     // e.g. ["BTC","ETH","OTHER"]
const pieValuesRaw = /*[[${pieValues}]]*/ [];  // e.g. [1234.56, 789.01, 23.45]
const pieValues = pieValuesRaw.map(Number);    // ensure numbers

const ctx = document.getElementById('pie');
if (ctx && pieLabels.length && pieValues.length) {
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: pieLabels,
      datasets: [{
        label: 'Portfolio share',
        data: pieValues
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          callbacks: {
            label: (item) => `${item.label}: ${Number(item.raw).toLocaleString(undefined, {maximumFractionDigits: 2})}`
          }
        }
      }
    }
  });
}
/*]]>*/
</script>
</body>
</html>
