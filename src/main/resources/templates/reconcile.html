<!-- src/main/resources/templates/reconcile.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Reconciliation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; color:#222; }
    .bar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:14px; }
    input, select, button, a.btn { padding:.45rem .7rem; border:1px solid #d0d0d0; border-radius:8px; background:#fafafa; }
    button { cursor:pointer; } button:hover, a.btn:hover { background:#f0f0f0; }
    a.btn { text-decoration:none; color:#222; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border-bottom:1px solid #eee; padding:.5rem .75rem; text-align:left; }
    th { background:#fafafa; position:sticky; top:0; z-index:1; }
    .right { text-align:right; }
    .delta-pos { color:#0a7; font-weight:600; }  /* snapshot > tx (surplus vs tx) */
    .delta-neg { color:#c33; font-weight:600; }  /* snapshot < tx (short vs tx) */
    .muted { color:#777; font-size:.9rem; }
    .totals { display:flex; gap:16px; margin:10px 0 18px; flex-wrap:wrap; }
    .pill { border:1px solid #ececec; border-radius:999px; padding:6px 10px; background:#fff; }
  </style>
</head>
<body>
<h1>Reconciliation</h1>

<form class="bar" method="get" action="/reconcile">
    <label>Account</label>
    <input type="text" name="account" th:value="${account}">

    <label>Platform</label>
    <select name="platform" th:value="${platform}">
        <option value="binance" th:selected="${platform=='binance'}">Binance</option>
        <!-- <option value="kraken" th:selected="${platform=='kraken'}">Kraken</option> -->
    </select>

    <label>Min |Δ|</label>
    <input type="number" step="0.00000001" name="minAbsDelta" th:value="${minAbsDelta}" placeholder="0.00000010">

    <label>Sort</label>
    <select name="sort" th:value="${sort}">
        <option value="deltaDesc" th:selected="${sort=='deltaDesc'}">By |Δ| desc</option>
        <option value="assetAsc" th:selected="${sort=='assetAsc'}">By asset A→Z</option>
    </select>

    <button type="submit">Apply</button>
    <a class="btn" th:href="@{'/dashboard'(account=${account}, vs='gbp')}">← Dashboard</a>
</form>

<div class="totals">
    <div class="pill">Snapshot Σ: <strong th:text="${#numbers.formatDecimal(totalSnapshot,1,8)}">0</strong></div>
    <div class="pill">Tx Σ: <strong th:text="${#numbers.formatDecimal(totalTx,1,8)}">0</strong></div>
    <div class="pill">Σ |Δ|: <strong th:text="${#numbers.formatDecimal(totalAbsDelta,1,8)}">0</strong></div>
</div>

<table>
    <thead>
    <tr>
        <th>Asset</th>
        <th class="right">Snapshot</th>
        <th class="right">Tx-derived</th>
        <th class="right">Δ (Snap − Tx)</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="l : ${lines}">
        <td th:text="${l.asset()}">BTC</td>
        <td class="right" th:text="${#numbers.formatDecimal(l.fromSnapshot(),1,8)}">0.00000000</td>
        <td class="right" th:text="${#numbers.formatDecimal(l.fromTx(),1,8)}">0.00000000</td>
        <td class="right"
            th:classappend="${l.delta().signum() >= 0} ? 'delta-pos' : 'delta-neg'"
            th:text="${#numbers.formatDecimal(l.delta(),1,8)}">0.00000000</td>
    </tr>
    <tr th:if="${#lists.isEmpty(lines)}">
        <td colspan="4" class="muted">No rows — adjust filters or ingest more history.</td>
    </tr>
    </tbody>
</table>


<!-- Ingest: Trades / Deposits / Withdrawals / Dust / Convert / Rewards / All -->
<div class="bar" style="gap:10px; flex-wrap: wrap;">
    <!-- Trades -->
    <form method="post" action="/binance/ingest-trades">
        <input type="hidden" name="account" th:value="${account}">
        <button type="submit">Ingest Trades</button>
    </form>

    <!-- Deposits -->
    <form method="post" action="/binance/ingest-deposits">
        <input type="hidden" name="account" th:value="${account}">
        <button type="submit">Ingest Deposits</button>
    </form>

    <!-- Withdrawals -->
    <form method="post" action="/binance/ingest-withdrawals">
        <input type="hidden" name="account" th:value="${account}">
        <button type="submit">Ingest Withdrawals</button>
    </form>

    <!-- Dust -->
    <form method="post" action="/binance/ingest-dust">
        <input type="hidden" name="account" th:value="${account}">
        <button type="submit">Ingest Dust</button>
    </form>

    <!-- Convert -->
    <form method="post" action="/binance/ingest-convert">
        <input type="hidden" name="account" th:value="${account}">
        <button type="submit">Ingest Convert</button>
    </form>

    <!-- Rewards -->
    <form method="post" action="/binance/ingest-rewards">
        <input type="hidden" name="account" th:value="${account}">
        <button type="submit">Ingest Rewards</button>
    </form>

    <!-- All since last checkpoint -->
    <form method="post" action="/dashboard/ingest-all">
        <input type="hidden" name="account" th:value="${account}">
        <input type="hidden" name="vs" th:value="${vs}">
        <button type="submit" style="font-weight:600;">Ingest All (since checkpoint)</button>
    </form>
</div>


<p class="muted" style="margin-top:10px;">
    Notes: Tx-derived = net(BUY, DEPOSIT, CONVERT_IN, REWARD) − net(SELL, WITHDRAW, CONVERT_OUT) − Σ fees (grouped by fee asset).
</p>
</body>
</html>
