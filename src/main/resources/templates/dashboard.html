<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Portfolio Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <style>
    :root { --gap: 14px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; color:#222; }
    .bar { display:flex; gap:var(--gap); align-items:center; margin-bottom:var(--gap); flex-wrap: wrap; }
    input, select, button { padding:.45rem .7rem; border:1px solid #d0d0d0; border-radius:8px; background:#fafafa; }
    button { cursor:pointer; } button:hover { background:#f0f0f0; }
    a.btn { display:inline-block; padding:.45rem .7rem; border:1px solid #ccc; border-radius:8px; background:#f7f7f7; text-decoration:none; color:#222; }
    a.btn:hover { background:#efefef; }

    .cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:var(--gap); margin: 18px 0; }
    .card { border:1px solid #ececec; border-radius:12px; padding:16px; background:#fff; box-shadow:0 1px 4px rgba(0,0,0,.04);}
    .card h3 { margin:0 0 6px 0; font-size:1rem; font-weight:600; }
    .money { font-weight:700; font-size:1.25rem; }
    .muted { color:#777; font-size:.9rem; }
    .right { text-align:right; }
    table { border-collapse: collapse; width:100%; }
    th, td { border-bottom:1px solid #eee; padding:0.5rem 0.75rem; text-align:left; }
    th { background:#fafafa; position:sticky; top:0; }

    /* two-column layout for table + pie */
    .content {
      display:grid;
      grid-template-columns: 1fr 360px;   /* table grows, pie fixed */
      gap: 20px;
      align-items: start;
      margin-top: 10px;
    }
    .pie-card { position: sticky; top: 12px; }
    .pie-wrap { width: 100%; height: 360px; }
    canvas#pie { width: 100% !important; height: 100% !important; }

    /* Responsive: stack on small screens */
    @media (max-width: 900px) {
      .content { grid-template-columns: 1fr; }
      .pie-wrap { height: 300px; }
    }
  </style>
</head>
<body>
<h1>Portfolio Dashboard</h1>

<!-- Filters -->
<form class="bar" method="get" action="/dashboard">
    <label>Account</label>
    <input type="text" name="account" th:value="${account}">

    <label>Currency</label>
    <select name="vs" th:value="${vs}">
        <option value="gbp" th:selected="${vs=='gbp'}">GBP</option>
        <option value="usd" th:selected="${vs=='usd'}">USD</option>
        <option value="eur" th:selected="${vs=='eur'}">EUR</option>
    </select>

    <label>Min value</label>
    <input type="number" step="0.01" name="minValue" th:value="${minValue}">

    <label>Min %</label>
    <input type="number" step="0.001" name="minPct" th:placeholder="0.005" th:value="${minPct}">

    <label>Pie top</label>
    <input type="number" name="top" min="1" th:value="${top}">

    <input type="hidden" name="platform" th:value="${platform}">
    <button type="submit">Apply</button>
    <a class="btn" th:href="@{'/dashboard'(account=${account},vs=${vs})}">Reset</a>
    <a class="btn" th:href="@{'/'(account=${account})}">Balances</a>
</form>

<!-- Refresh -->
<form class="bar" method="post" action="/dashboard/refresh">
    <input type="hidden" name="account" th:value="${account}">
    <input type="hidden" name="vs" th:value="${vs}">
    <button type="submit">Refresh balances (Binance + Kraken)</button>
    <span class="muted">Requires API keys set in env.</span>
</form>

<div class="bar">
    <form method="post" action="/ingest/binance">
        <input type="hidden" name="account" th:value="${account}">
        <button type="submit">Fetch from Binance</button>
    </form>
    <form method="post" action="/ingest/kraken">
        <input type="hidden" name="account" th:value="${account}">
        <button type="submit">Fetch from Kraken</button>
    </form>
    <span class="muted">Requires API keys configured via env.</span>
</div>


<!-- Subtotals; each card links to drilldown -->
<div class="cards">
    <a class="card" th:each="p : ${platformTotals}"
       th:href="@{'/dashboard'(account=${account},vs=${vs},platform=${p.exchange()},minValue=${minValue},minPct=${minPct},top=${top})}"
       style="text-decoration:none;color:inherit;">
        <h3 th:text="${#strings.capitalize(p.exchange())}">Binance</h3>
        <div class="money">
            <span th:text="${#numbers.formatDecimal(p.value(),1,2)}">0.00</span>
            <span th:text="${vs.toUpperCase()}">GBP</span>
        </div>
        <div class="muted">Click to drill down</div>
    </a>

    <div class="card">
        <h3>Total</h3>
        <div class="money">
            <span th:text="${#numbers.formatDecimal(total,1,2)}">0.00</span>
            <span th:text="${vs.toUpperCase()}">GBP</span>
        </div>
        <div class="muted" th:if="${platform}">
            Filtering platform: <strong th:text="${platform}">binance</strong>
            &nbsp;(<a th:href="@{'/dashboard'(account=${account},vs=${vs},minValue=${minValue},minPct=${minPct},top=${top})}">clear</a>)
        </div>
        <div class="muted" th:if="${unresolved != null && !unresolved.isEmpty()}">
            Unresolved: <span th:text="${unresolved}">[]</span>
        </div>
    </div>
</div>

<!-- Table + Pie side-by-side -->
<div class="content">
    <!-- LEFT: tokens table -->
    <div>
        <table th:if="${tokens != null and !tokens.isEmpty()}">
            <thead>
            <tr>
                <th style="width:120px;">Platform</th>
                <th>Token</th>
                <th class="right">Qty</th>
                <th class="right">Price (<span th:text="${vs.toUpperCase()}">GBP</span>)</th>
                <th class="right">Value (<span th:text="${vs.toUpperCase()}">GBP</span>)</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="t : ${tokens}">
                <td th:text="${t.exchange()}">binance</td>
                <td th:text="${t.asset()}">BTC</td>
                <td class="right" th:text="${#numbers.formatDecimal(t.qty(),1,8)}">0.00000000</td>
                <td class="right" th:text="${#numbers.formatDecimal(t.price(),1,6)}">0.00</td>
                <td class="right" th:text="${#numbers.formatDecimal(t.value(),1,2)}">0.00</td>
            </tr>
            </tbody>
        </table>
        <div class="muted" th:if="${tokens == null or tokens.isEmpty()}">No valued assets yet.</div>
    </div>

    <!-- RIGHT: pie -->
    <div class="card pie-card">
        <h3>Allocation</h3>
        <div class="pie-wrap">
            <canvas id="pie"></canvas>
        </div>
        <div class="muted" th:if="${pie == null or pie.isEmpty()}">No valued assets yet.</div>
    </div>
</div>

<!-- Ingest: Trades / Deposits / Withdrawals / Dust / Convert / Rewards / All -->
<div class="bar" style="gap:10px; flex-wrap: wrap;">
    <!-- Trades -->
    <form method="post" action="/binance/ingest-trades">
        <input type="hidden" name="account" th:value="${account}">
        <button type="submit">Ingest Trades</button>
    </form>

    <!-- Deposits -->
    <form method="post" action="/binance/ingest-deposits">
        <input type="hidden" name="account" th:value="${account}">
        <button type="submit">Ingest Deposits</button>
    </form>

    <!-- Withdrawals -->
    <form method="post" action="/binance/ingest-withdrawals">
        <input type="hidden" name="account" th:value="${account}">
        <button type="submit">Ingest Withdrawals</button>
    </form>

    <!-- Dust -->
    <form method="post" action="/binance/ingest-dust">
        <input type="hidden" name="account" th:value="${account}">
        <button type="submit">Ingest Dust</button>
    </form>

    <!-- Convert -->
    <form method="post" action="/binance/ingest-convert">
        <input type="hidden" name="account" th:value="${account}">
        <button type="submit">Ingest Convert</button>
    </form>

    <!-- Rewards -->
    <form method="post" action="/binance/ingest-rewards">
        <input type="hidden" name="account" th:value="${account}">
        <button type="submit">Ingest Rewards</button>
    </form>

    <!-- All since last checkpoint -->
    <form method="post" action="/dashboard/ingest-all">
        <input type="hidden" name="account" th:value="${account}">
        <input type="hidden" name="vs" th:value="${vs}">
        <button type="submit" style="font-weight:600;">Ingest All (since checkpoint)</button>
    </form>
</div>

<a class="btn" th:href="@{'/reconcile'(account=${account}, platform='binance')}">Reconcile</a>
<p><a href="/tx">View All Transactions</a></p>


<!-- Chart -->
<script th:inline="javascript">
  /*<![CDATA[*/
    const labels   = /*[[${pieLabels}]]*/ [];
    const dataVals = /*[[${pieValues}]]*/ [];
    const currency = /*[[${vs}]]*/ 'gbp';

    if (labels.length) {
      const ctx = document.getElementById('pie').getContext('2d');
      new Chart(ctx, {
        type: 'pie', // change to 'doughnut' if you prefer
        data: { labels, datasets: [{ data: dataVals }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,   // respect .pie-wrap height
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: (item) => {
                  const v = item.parsed || 0;
                  return `${item.label}: ${v.toLocaleString(undefined,{maximumFractionDigits:2})} ${currency.toUpperCase()}`;
                }
              }
            }
          },
          layout: { padding: 4 }
        }
      });
    }
  /*]]>*/
  </script>
</body>
</html>
