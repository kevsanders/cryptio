<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="~{fragments/layout :: head('Dashboard')}"></head>
<body>
<header th:replace="~{fragments/layout :: header('dashboard')}"></header>

<main id="app" class="container" :class="{ready: mountedOk}" v-cloak>
    <!-- Filters -->
    <form class="bar" @submit.prevent="applyFilters">
        <label>Account</label>
        <input name="account" v-model="account" placeholder="primary"/>
        <label>Fiat</label>
        <select name="vs" v-model="vs">
            <option value="gbp">GBP</option>
            <option value="usd">USD</option>
            <option value="eur">EUR</option>
        </select>
        <button type="submit">Apply</button>
        <a class="btn" :href="`/reconcile?account=${encodeURIComponent(account)}`">Reconcile</a>
        <a class="btn" :href="`/tx?account=${encodeURIComponent(account)}`">Transactions</a>
    </form>

    <div class="grid g2">
        <!-- LEFT: Platform totals + Pie -->
        <section class="card">
            <h2>Platform totals</h2>
            <div class="content">
                <div id="platformTable"></div>

                <!-- Pie lives under the table -->
                <div class="pie-wrap">
                    <canvas id="pie"></canvas>
                </div>
            </div>
        </section>

        <!-- RIGHT: Top tokens only -->
        <section class="card">
            <h2 style="display:flex; align-items:center; justify-content:space-between;">
                <span>Allocation by token</span>
                <label style="display:flex; align-items:center; gap:8px; font-weight:600;">
                    <span>{{ exchangeFilter === 'total' ? 'Total' : exchangeFilter.charAt(0).toUpperCase() + exchangeFilter.slice(1) }}</span>
                    <select v-model="exchangeFilter" @change="applyExchangeFilter" style="min-width:120px;">
                        <option value="total">Total</option>
                        <option value="binance">binance</option>
                        <option value="kraken">kraken</option>
                    </select>
                </label>
            </h2>
            <div class="content">
                <div id="topTokensTable"></div>
                <div class="muted" style="margin-top:8px">Small positions are grouped into “Other”.</div>
            </div>
        </section>
    </div>

    <!-- Ingest buttons -->
    <section class="card" style="margin-top:16px">
        <h2>Ingest</h2>
        <div class="content bar">
            <button @click="ingest('/binance/ingest-trades')">Trades</button>
            <button @click="ingest('/binance/ingest-deposits')">Deposits</button>
            <button @click="ingest('/binance/ingest-withdrawals')">Withdrawals</button>
            <button @click="ingest('/binance/ingest-dust')">Dust</button>
            <button @click="ingest('/binance/ingest-convert')">Convert</button>
            <button @click="ingest('/binance/ingest-rewards')">Rewards</button>
            <button @click="ingest('/dashboard/ingest-all', {vs})"><strong>All (since checkpoint)</strong></button>
            <button @click="ingest('/binance/ingest-trades-from-list', {vs, since:'2019-01-01T00:00:00Z'})">Trades (from list)</button>
        </div>
    </section>
</main>

<footer th:replace="~{fragments/layout :: footer}"></footer>



<script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
<script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      account: new URLSearchParams(location.search).get('account') || 'primary',
      vs: (new URLSearchParams(location.search).get('vs') || 'gbp').toLowerCase(),
      platformTotals: [],
      grandTotal: 0,
      topTokens: [],
      pie: { labels: [], values: [] },
      pieChart: null,
      csrf: {
        token: document.querySelector('meta[name="_csrf"]')?.content,
        header: document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN'
      },
      busy: false,
      mountedOk: false,

      //enable exchange filter
      exchangeFilter: 'total',   // <— ADD THIS

      // NEW: grid handles
      platformGrid: null,
      tokensGrid: null,
    };
  },
  methods: {
    async load() {
      try {
        const params = { account: this.account, vs: this.vs };
        if (this.exchangeFilter !== 'total') params.exchange = this.exchangeFilter;
        const q = new URLSearchParams(params);
        const res = await fetch(`/api/dashboard?${q}`, { credentials: 'same-origin' });
        if (!res.ok) throw new Error(`Failed to load dashboard: ${res.status} ${res.statusText}`);
        const ct = res.headers.get('content-type') || '';
        if (!ct.includes('application/json')) {
          const text = await res.text();
          console.error('Expected JSON, got:', ct, text.slice(0, 300));
          throw new Error('Backend returned non-JSON (possibly login or error HTML).');
        }

        const data = await res.json();
        this.platformTotals = data.platformTotals || [];
        this.grandTotal     = data.grandTotal ?? 0;
        this.topTokens      = data.topTokens || [];
        this.pie            = data.pie || { labels: [], values: [] };

        this.renderPie();
        this.renderTables();
        this.mountedOk = true; // success — allow uncloak
      } catch (e) {
        console.error(e);
        alert(e.message);
      }
    },

    // NEW: Grid.js tables with numeric sorting + pretty formatting
    renderTables() {
      // PLATFORM TOTALS
        const platEl = document.getElementById('platformTable');
        if (platEl) {
          // base rows
          const platRows = this.platformTotals.map(p => [p.platform, Number(p.value ?? 0)]);
          // append grand total
          platRows.push(['Total', Number(this.grandTotal ?? 0)]);

          const gbpFmt = (n) => Number(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

          const platColumns = [
            {
              name: 'Platform',
              // keep "Total" at the bottom when sorting by Platform
              sort: {
                compare: (a, b) => (a === 'Total') - (b === 'Total') || String(a).localeCompare(String(b))
              },
              formatter: (cell, row) =>
                row?.cells?.[0]?.data === 'Total'
                  ? gridjs.html('<strong>Total</strong>')
                  : cell
            },
            {
              name: `Value (${this.vs.toUpperCase()})`,
              attributes: { 'class': 'right' },
              // disable value sorting to keep the Total row pinned at the bottom
              // (Grid.js cell-only comparator can’t easily detect the row to push it down)
              sort: false,
              formatter: (cell, row) => {
                const v = gbpFmt(cell);
                return row?.cells?.[0]?.data === 'Total'
                  ? gridjs.html(`<strong>${v}</strong>`)
                  : gridjs.html(v);
              }
            }
          ];

          if (!this.platformGrid) {
            this.platformGrid = new gridjs.Grid({
              columns: platColumns,
              data: platRows,
              pagination: false,
              sort: true,   // still allows sorting on the Platform column; Value column sort is disabled
              search: true,
              className: { table: 'w-100' }
            }).render(platEl);
          } else {
            this.platformGrid
              .updateConfig({ columns: platColumns, data: platRows })
              .forceRender();
          }
      }

      // TOP TOKENS
      const tokEl = document.getElementById('topTokensTable');
      if (tokEl) {
        const tokenData = this.topTokens.map(r => [r.asset, Number(r.value ?? 0)]);
        const tokColumns = [
          { name: 'Token' },
          {
            name: `Value (${this.vs.toUpperCase()})`,
            attributes: { 'class': 'right' },
            sort: { compare: (a, b) => a - b },
            formatter: (cell) => Number(cell).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })
          }
        ];

        if (!this.tokensGrid) {
          this.tokensGrid = new gridjs.Grid({
            columns: tokColumns,
            data: tokenData,
            pagination: false,
            sort: true,
            search: true,
            className: { table: 'w-100' }
          }).render(tokEl);
        } else {
          this.tokensGrid.updateConfig({ columns: tokColumns, data: tokenData }).forceRender();
        }
      }
    },
    applyExchangeFilter() {
      // persist selection to URL (optional)
      const q = new URLSearchParams({ account: this.account, vs: this.vs });
      if (this.exchangeFilter !== 'total') q.set('exchange', this.exchangeFilter);
      history.replaceState(null, '', `/api/dashboard?${q}`);

      this.load(); // refresh tokens + pie for selected exchange
    },

    renderPie() {
      const canvas = document.getElementById('pie');
      if (!canvas) return; // harmless if missing
      const ctx = canvas.getContext('2d');
      if (this.pieChart) this.pieChart.destroy();
      if (!this.pie.labels.length) return;

      this.pieChart = new Chart(ctx, {
        type: 'pie',
        data: { labels: this.pie.labels, datasets: [{ data: this.pie.values }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,          // <— let it fill .pie-wrap
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: (item) =>
                  `${item.label}: ${Number(item.raw).toLocaleString(undefined, { maximumFractionDigits: 2 })}`
              }
            }
          }
        }
      });
    },
    async ingest(path, extra = {}) {
      if (this.busy) return;
      this.busy = true;
      try {
        const form = new URLSearchParams({ account: this.account, ...extra });
        const headers = { 'Content-Type': 'application/x-www-form-urlencoded' };
        if (this.csrf.token) headers[this.csrf.header] = this.csrf.token;

        const res = await fetch(path, { method: 'POST', body: form, headers, credentials: 'same-origin' });
        if (!res.ok) throw new Error(`Ingest failed: ${res.status} ${res.statusText}`);
        await this.load();
      } catch (e) {
        console.error(e);
        alert(e.message);
      } finally {
        this.busy = false;
      }
    },
    applyFilters() {
      const q = new URLSearchParams({ account: this.account, vs: this.vs });
      if (this.exchangeFilter !== 'total') q.set('exchange', this.exchangeFilter); // <— keep it
      history.replaceState(null, '', `/api/dashboard?${q}`);
      this.load();
    },
    format2(n) {
      return Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
  },
  async mounted() {
    const qs = new URLSearchParams(location.search);
    const ex = (qs.get('exchange') || 'total').toLowerCase();
    if (['binance','kraken','total'].includes(ex)) this.exchangeFilter = ex;
    console.log('Vue app mounted: starting load()');
    await this.load();
    // If you still see a blank page, check the console/network tab after this.
  }
}).mount('#app');
</script>

<style>

/* === Grid.js clean non-sticky setup === */

/* Show a normal search bar */
.gridjs-head {
  display: flex;
  align-items: center;
  padding: 6px 8px;
  margin-bottom: 6px;
}

/* Absolutely disable sticky header everywhere */
.gridjs-table thead,
.gridjs-table thead tr,
.gridjs-table thead th.gridjs-th {
  position: static !important;
  top: auto !important;
  transform: none !important;
}

/* No reserved space for sticky header */
:root { --gridjs-head-height: 0px; }
.gridjs-container { padding-top: 0 !important; }

/* Hide pagination only */
.gridjs-pagination { display: none !important; }

/* Optional: remove the “Showing …” line */
.gridjs-summary { display: none; }

/* Keep header/body widths in sync and avoid wrapping */
.gridjs-table { table-layout: fixed; width: 100%; }
.gridjs-th, .gridjs-td { white-space: nowrap; }

/* If any wrapper added a scrollbox height earlier, undo it */
.gridjs-wrapper { max-height: none !important; height: auto !important; overflow: visible !important; }

/* Your helpers */
.right { text-align: right; }
.w-100 { width: 100%; }

</style>

</body>
</html>
